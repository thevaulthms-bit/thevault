<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Vault</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA5kS0tUROuAINTQH387kwxWBqwjn-mbJA",
  authDomain: "the-vault-b5294.firebaseapp.com",
  projectId: "the-vault-b5294",
  storageBucket: "the-vault-b5294.firebasestorage.app",
  messagingSenderId: "173280236722",
  appId: "1:173280236722:web:a5a6319b447e9569e525ab",
  measurementId: "G-5M3C7NRW87"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>

<style>
:root{
  --bg0:#07070a;
  --bg1:#0b0b12;
  --panel:#0f1020;
  --panel2:#0b0c18;
  --line: rgba(255,255,255,.10);
  --line2: rgba(255,255,255,.14);
  --text: rgba(255,255,255,.88);
  --muted: rgba(255,255,255,.62);
  --muted2: rgba(255,255,255,.45);

  --p1:#b06cff;
  --p2:#7c4dff;
  --p3:#39d0ff;
  --ok:#4dffb3;
  --warn:#ffd36c;
  --bad:#ff5c5c;

  --shadow: 0 22px 70px rgba(0,0,0,.60);
  --shadow2: 0 14px 45px rgba(0,0,0,.35);
  --r:18px;
  --r2:26px;
  --blur: blur(18px);

  --brand-logo: url("/thevaultlogo.png");
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--text);
  background:
    radial-gradient(1100px 700px at 80% -10%, rgba(176,108,255,.20), transparent 60%),
    radial-gradient(900px 650px at 10% 10%, rgba(57,208,255,.12), transparent 55%),
    radial-gradient(900px 700px at 40% 120%, rgba(124,77,255,.16), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* Scrollbars */
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.10);
  border: 2px solid rgba(0,0,0,.25);
  border-radius: 999px;
}
*::-webkit-scrollbar-thumb:hover{background: rgba(255,255,255,.16)}
*::-webkit-scrollbar-corner{background: transparent}

/* ===== Sidebar ===== */
.sidebar{
  width: 360px;
  min-width: 320px;
  max-width: 420px;
  padding: 16px;
  display:flex;
  flex-direction:column;
  gap: 14px;
  border-right: 1px solid var(--line);
  background:
    radial-gradient(520px 360px at 70% 0%, rgba(176,108,255,.16), transparent 60%),
    linear-gradient(180deg, rgba(15,16,32,.86), rgba(10,10,18,.86));
  backdrop-filter: var(--blur);
  box-shadow: 10px 0 40px rgba(0,0,0,.28);
}

.sidebar-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding: 10px 10px 6px;
  border: 1px solid rgba(255,255,255,.10);
  border-radius: var(--r2);
  background: rgba(255,255,255,.03);
}

.brand{
  display:flex; align-items:center; gap:10px;
}
  .logo{
    width:36px; height:36px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.14);
    background:
      var(--brand-logo) center / cover no-repeat,
      radial-gradient(12px 12px at 30% 30%, rgba(255,255,255,.25), transparent 60%),
      linear-gradient(135deg, rgba(176,108,255,.95), rgba(124,77,255,.85), rgba(57,208,255,.55));
    box-shadow: 0 16px 50px rgba(176,108,255,.18);
    position:relative;
    overflow:hidden;
  }

.logo:after{
  content:"";
  position:absolute; inset:-45%;
  background: conic-gradient(from 180deg, rgba(255,255,255,0), rgba(255,255,255,.18), rgba(255,255,255,0));
  animation: spin 7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.brand .name{font-weight:900; letter-spacing:-.2px}
.brand .tag{color:var(--muted2); font-size:12px; margin-top:2px}

.pill{
  font-size:12px; font-weight:800;
  padding:6px 10px;
  border-radius:999px;
  color:rgba(0,0,0,.75);
  background: linear-gradient(135deg, rgba(77,255,179,.95), rgba(57,208,255,.70));
}

/* Buttons + Inputs */
.btn{
  width:100%;
  padding: 12px 12px;
  font-size: 14px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  cursor:pointer;
  font-weight: 800;
  letter-spacing:.2px;
  transition: transform .12s ease, background .12s ease, border-color .12s ease, filter .12s ease;
  display:flex; align-items:center; justify-content:center; gap:10px;
  user-select:none;
}
.btn:hover{background: rgba(255,255,255,.07); transform: translateY(-1px)}
.btn:active{transform: translateY(0)}
.btn.primary{
  background: linear-gradient(135deg, rgba(176,108,255,.95), rgba(124,77,255,.78));
  border-color: rgba(255,255,255,.18);
  box-shadow: 0 18px 60px rgba(124,77,255,.22);
}
.btn.primary:hover{filter: brightness(1.06) saturate(1.07)}
.btn.ghost{
  background: rgba(0,0,0,.10);
}
.btn.danger{
  background: rgba(255,92,92,.14);
  border-color: rgba(255,92,92,.30);
}
.btn.danger:hover{background: rgba(255,92,92,.18)}
.btn.small{
  padding: 10px 10px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 800;
}

.input{
  width:100%;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.20);
  color: var(--text);
  outline:none;
}
.input::placeholder{color: rgba(255,255,255,.45)}
.input:focus{
  border-color: rgba(176,108,255,.40);
  box-shadow: 0 0 0 4px rgba(176,108,255,.12);
}

/* ===== Search ===== */
.search-wrap{
  display:none;
  gap:8px;
  align-items:center;
}
.search-bar{flex:1}

/* ===== Tip ===== */
.tip{
  font-size: 12px;
  color: var(--muted2);
  margin: 0 2px;
}

/* ===== Results ===== */
.results{
  display:none;
  overflow-y:auto;
  flex: 1;
  flex-direction:column;
  gap: 8px;
  padding-right: 2px;
}
.game-btn{
  width:100%;
  height: 44px;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  padding: 0 12px;
  text-align:left;

  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  color: rgba(255,255,255,.86);
  cursor:pointer;
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
.game-btn:hover{
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.16);
  transform: translateY(-1px);
}

/* ===== Shop ===== */
.shop-panel{
  display:none;
  flex-direction:column;
  gap: 14px;
  border-radius: var(--r2);
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(520px 340px at 70% 0%, rgba(176,108,255,.18), transparent 60%),
    linear-gradient(180deg, rgba(15,16,32,.92), rgba(10,10,18,.92));
  box-shadow: var(--shadow2);
  padding: 14px;
  max-height: 70vh;
  overflow-y:auto;
}
.shop-header h2{
  margin:0;
  font-size: 16px;
  letter-spacing:-.2px;
}
.shop-header p{
  margin:6px 0 0;
  font-size: 12px;
  color: var(--muted2);
}
.shop-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 10px;
}
.shop-card{
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  padding: 12px;
  display:flex;
  flex-direction:column;
  gap: 8px;
}
.shop-card h3{margin:0; font-size:14px}
.shop-card p{margin:0; font-size:12px; color: var(--muted)}
.shop-card button{
  margin-top:4px;
  width:100%;
  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  cursor:pointer;
  font-weight: 900;
}
.unlock-btn{
  background: linear-gradient(135deg, rgba(176,108,255,.92), rgba(124,77,255,.74));
  border-color: rgba(255,255,255,.16);
  color:white;
}
.unlock-btn:hover{filter: brightness(1.06)}
.open-btn{
  background: linear-gradient(135deg, rgba(77,255,179,.92), rgba(57,208,255,.70));
  border-color: rgba(255,255,255,.16);
  color: rgba(0,0,0,.82);
}
.open-btn:hover{filter: brightness(1.05)}
.shop-close{
  width:100%;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.80);
  cursor:pointer;
  font-weight: 900;
}
.shop-close:hover{background: rgba(255,255,255,.07)}

/* Account panel */
#accountPanel{
  border-radius: var(--r2);
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  padding: 12px;
}
.kpiRow{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 10px;
}
.kpi{
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  padding: 10px;
}
.kpi .t{font-size:11px; color: var(--muted2)}
.kpi .v{margin-top:6px; font-weight: 1000; letter-spacing:-.2px}
.progress{
  margin-top:10px;
  height: 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  overflow:hidden;
}
#xpBar{
  height:100%;
  width:0%;
  border-radius:999px;
  background: linear-gradient(90deg, rgba(77,255,179,.9), rgba(57,208,255,.75), rgba(176,108,255,.78));
}
.helper{
  margin-top: 8px;
  font-size: 12px;
  color: var(--muted2);
  line-height: 1.5;
}

/* ===== Main ===== */
.main{
  flex:1;
  display:flex;
  flex-direction:column;
  background: rgba(0,0,0,.20);
}

/* ===== Top Bar ===== */
.top-bar{
  height: 84px;
  flex-shrink:0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 14px;
  padding: 0 14px;

  border-bottom: 1px solid var(--line);
  background:
    radial-gradient(900px 360px at 60% 0%, rgba(176,108,255,.18), transparent 60%),
    linear-gradient(180deg, rgba(12,12,20,.92), rgba(8,8,12,.92));
  backdrop-filter: var(--blur);
}
#announcement{
  flex:1;
  color: rgba(255,255,255,.70);
  font-size: 13px;
  line-height: 1.3;
  padding: 12px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
  transition: opacity .25s ease;
}
.ad-slot{
  width: 728px;
  height: 90px;
  flex-shrink:0;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.02);
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* ===== Iframe ===== */
.frame-container{
  flex:1;
  position:relative;
  padding: 12px;
}
.frame-shell{
  width:100%;
  height:100%;
  border-radius: 22px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.25);
  overflow:hidden;
  box-shadow: var(--shadow);
}
iframe{
  width:100%;
  height:100%;
  border:none;
}

/* ===== Fullscreen ===== */
.fullscreen-btn{
  position: fixed;
  bottom: 14px;
  right: 14px;
  padding: 10px 14px;
  font-size: 13px;
  border-radius: 14px;
  cursor:pointer;
  z-index: 2147483647;
  pointer-events:auto;

  border: 1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.55);
  color: rgba(255,255,255,.85);
  backdrop-filter: var(--blur);
  box-shadow: 0 20px 60px rgba(0,0,0,.55);
}
.fullscreen-btn:hover{background: rgba(0,0,0,.65)}

/* Hide UI in fullscreen */
.fullscreen .sidebar,
.fullscreen .top-bar,
.fullscreen .fullscreen-btn{
  display:none;
}

/* ===== Final Popup ===== */
#finalPopup{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,.70);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 999999;
  padding: 18px;
}
#finalPopupBox{
  width: min(560px, 100%);
  padding: 18px;
  border-radius: 26px;
  border: 1px solid rgba(255,255,255,.14);
  background:
    radial-gradient(520px 320px at 70% 0%, rgba(176,108,255,.22), transparent 60%),
    linear-gradient(180deg, rgba(15,16,32,.96), rgba(10,10,18,.96));
  box-shadow: 0 30px 90px rgba(0,0,0,.70);
  animation: popupFade .22s ease;
}
#finalPopupBox h2{margin:0 0 8px; font-size: 18px; letter-spacing:-.2px}
#finalPopupBox p{margin: 8px 0; color: var(--muted); line-height: 1.6; font-size: 14px}
#finalPopupBox button{
  margin-top: 12px;
  width:100%;
  padding: 12px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.16);
  background: linear-gradient(135deg, rgba(176,108,255,.92), rgba(124,77,255,.76));
  color:white;
  font-weight: 950;
  cursor:pointer;
}
#finalPopupBox button:hover{filter: brightness(1.06)}
@keyframes popupFade{
  from{transform: translateY(6px) scale(.98); opacity:0}
  to{transform: translateY(0) scale(1); opacity:1}
}

/* Responsive */
@media (max-width: 1100px){
  .ad-slot{display:none}
  .sidebar{width: 330px}
}
@media (max-width: 820px){
  body{flex-direction:column}
  .sidebar{
    width:100%;
    max-width:none;
    min-width:0;
    border-right:0;
    border-bottom:1px solid var(--line);
    max-height: 46vh;
  }
  .main{min-height: 54vh}
}
</style>
</head>

<body>

<!-- ===== Sidebar ===== -->
<div class="sidebar">
  <div class="sidebar-header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="name">The Vault</div>
        <div class="tag">Games ‚Ä¢ Shop ‚Ä¢ Account</div>
      </div>
    </div>
    <div class="pill">Online</div>
  </div>

  <button class="btn primary" id="shopBtn">üõí Shop</button>
  <button class="btn ghost" id="gamesBtn">üéÆ Games</button>

  <div class="search-wrap" id="searchWrap">
    <input class="input search-bar" id="searchInput" placeholder="Search games..." />
    <button class="btn danger small" onclick="closeSearch()" style="width:auto">‚úï</button>
  </div>

  <div class="tip" id="tip" style="display:none;">
    Right click a game to favorites
  </div>

  <div class="results" id="results"></div>

  <div id="shopPanel" class="shop-panel">
    <div class="shop-header">
      <h2>Vault Shop</h2>
      <p>Spend Keys to unlock features permanently</p>
    </div>
    <div id="shopItems" class="shop-grid"></div>
    <button class="shop-close" onclick="closeShop()">Close Shop</button>
  </div>

  <!-- ACCOUNT PANEL -->
  <div id="accountPanel">
    <div id="loginArea">
      <input id="email" class="input" placeholder="Email" style="margin-bottom:8px" />
      <input id="password" class="input" type="password" placeholder="Password" style="margin-bottom:10px" />
      <button class="btn primary" onclick="signup()" style="margin-bottom:8px;">Create account</button>
      <button class="btn" onclick="login()">Login</button>
    </div>

    <div id="userArea" style="display:none;">
      <div class="kpiRow">
        <div class="kpi">
          <div class="t">Keys</div>
          <div class="v">üîë <span id="keyCount">0</span></div>
        </div>
        <div class="kpi">
          <div class="t">XP</div>
          <div class="v">‚≠ê <span id="xpCount">0</span></div>
        </div>
      </div>

      <div class="progress" title="XP progress">
        <div id="xpBar"></div>
      </div>

      <button id="claimKeyBtn" class="btn primary" style="display:none; margin-top:10px;">
        Claim Key üîë
      </button>

      <div class="helper">
        Earn XP while active. Fill the bar to earn a Vault Key.
      </div>

      <button class="btn" onclick="logout()" style="margin-top:10px;">Logout</button>
    </div>
  </div>
</div>

<!-- ===== Main ===== -->
<div class="main">
  <div class="top-bar">
    <div id="announcement">Welcome to The Vault.</div>
    <div class="ad-slot"><div class="ad-slot" id="adSlot"></div></div>
  </div>

  <div class="frame-container" id="fullscreenTarget">
    <div class="frame-shell">
      <iframe id="gameframe"></iframe>
    </div>
  </div>
</div>

<button class="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>

<script src="/stash.js"></script>

<script>
/* ===============================
   FAVORITES
================================*/
const getFavorites = () => currentUserData?.favorites || [];

function toggleFavorite(name) {
  if (!auth.currentUser) {
    alert("Login to save favorites.");
    return;
  }
  const favs = getFavorites();
  const update = favs.includes(name)
    ? firebase.firestore.FieldValue.arrayRemove(name)
    : firebase.firestore.FieldValue.arrayUnion(name);
  db.collection("users").doc(auth.currentUser.uid).update({ favorites: update });
}

const isFavorite = (name) => getFavorites().includes(name);

/* ===============================
   UI LOGIC
================================*/
const gamesBtn = document.getElementById("gamesBtn");
const searchWrap = document.getElementById("searchWrap");
const searchInput = document.getElementById("searchInput");
const results = document.getElementById("results");
const tip = document.getElementById("tip");

gamesBtn.onclick = () => {
  document.querySelectorAll(".sidebar > button").forEach(b => b.style.display = "none");
  searchWrap.style.display = "flex";
  tip.style.display = "block";
  results.style.display = "flex";
  searchInput.focus();
  showResults("");
};

function closeSearch() {
  searchWrap.style.display = "none";
  tip.style.display = "none";
  results.style.display = "none";
  results.innerHTML = "";
  document.querySelectorAll(".sidebar > button").forEach(b => b.style.display = "flex");
}

searchInput.oninput = () => showResults(searchInput.value.toLowerCase());

function showResults(query) {
  results.innerHTML = "";
  const favs = getFavorites().filter(f => f.toLowerCase().includes(query));
  favs.forEach(renderGame);

  if (typeof files !== "undefined") {
    files
      .filter(f => !favs.includes(f))
      .filter(f => f.toLowerCase().includes(query))
      .slice(0, 200)
      .forEach(renderGame);
  }
}

function renderGame(name) {
  const btn = document.createElement("button");
  btn.className = "game-btn";
  btn.textContent = `${isFavorite(name) ? "‚òÖ" : "‚òÜ"} ${name}`;
  btn.onclick = () => loadUGS(name);
  btn.oncontextmenu = e => {
    e.preventDefault();
    toggleFavorite(name);
  };
  results.appendChild(btn);
}

/* ===============================
   GAME LOADER
================================*/
function loadUGS(file) {
  const iframe = document.getElementById("gameframe");
  const normalized = file.endsWith(".html") ? file : file + ".html";
  const url =
    `https://cdn.jsdelivr.net/gh/imEric1606/TheVaultStash/UGS-Files/` +
    `${encodeURIComponent(normalized)}?t=${Date.now()}`;

  fetch(url)
    .then(r => r.text())
    .then(html => iframe.srcdoc = html);
}

function loadDirect(url) {
  const frame = document.getElementById("gameframe");
  const wrapper = `
    <html>
      <head>
        <style>
          body, html { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:black; }
          iframe { width:100%; height:100%; border:none; }
        </style>
      </head>
      <body>
        <iframe src="${url}"></iframe>
      </body>
    </html>
  `;
  frame.src = "about:blank";
  frame.onload = () => {
    frame.contentWindow.document.open();
    frame.contentWindow.document.write(wrapper);
    frame.contentWindow.document.close();
  };
}

/* ===============================
   FULLSCREEN
================================*/
function toggleFullscreen() {
  const target = document.getElementById("fullscreenTarget");
  if (!target) return;

  if (!document.fullscreenElement) {
    target.requestFullscreen().catch(err => console.error("Fullscreen failed:", err));
  } else {
    document.exitFullscreen();
  }
}

document.addEventListener("fullscreenchange", () => {
  document.body.classList.toggle("fullscreen", !!document.fullscreenElement);
});
</script>

<script>
/* Announcements (kept neutral) */
const announcements = [
  "Welcome to The Vault.",
  "New updates and features drop from time to time ‚Äî check the shop.",
  "Tip: Use Games search to find favorites fast."
];

let index = 0;
const el = document.getElementById("announcement");

setInterval(() => {
  index = (index + 1) % announcements.length;
  el.style.opacity = 0;
  setTimeout(() => {
    el.textContent = announcements[index];
    el.style.opacity = 1;
  }, 220);
}, 4200);
</script>

<script>
function loadAd() {
  const adSlot = document.getElementById("adSlot");
  if (!adSlot) return;

  adSlot.innerHTML = "";

  window.atOptions = {
    key: "adadd3824fd9b5055083031dd994397d",
    format: "iframe",
    width: 728,
    height: 90,
    params: {}
  };

  const script = document.createElement("script");
  script.src = "https://www.highperformanceformat.com/adadd3824fd9b5055083031dd994397d/invoke.js";
  script.async = true;

  adSlot.appendChild(script);
}
loadAd();
setInterval(loadAd, 20000);
</script>

<script>
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginArea = document.getElementById("loginArea");
const userArea = document.getElementById("userArea");
const keyCount = document.getElementById("keyCount");
const xpCount = document.getElementById("xpCount");
const xpBar = document.getElementById("xpBar");
const claimKeyBtn = document.getElementById("claimKeyBtn");
const shopBtn = document.getElementById("shopBtn");
const shopPanel = document.getElementById("shopPanel");
const shopItems = document.getElementById("shopItems");

let currentUserData = null;
const DEVICE_BAN_PREFIX = "vaultDeviceBan:";

function normalizeBanEmail(email) {
  return String(email || "").trim().toLowerCase();
}
function getBanStorageKey(email) {
  const normalized = normalizeBanEmail(email);
  return normalized ? `${DEVICE_BAN_PREFIX}${normalized}` : "";
}
function setDeviceBan(email, banned) {
  const key = getBanStorageKey(email);
  if (!key) return;
  if (banned) localStorage.setItem(key, "1");
  else localStorage.removeItem(key);
}

function signup() {
  auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
    .then(cred => {
      return db.collection("users").doc(cred.user.uid).set({
        keys: 0,
        xp: 0,
        email: cred.user.email,
        unlocked: {},
        banned: false
      });
    })
    .catch(e => alert(e.message));
}

function featureIdFromName(name) {
  return name.toLowerCase().replace(/\s+/g, "");
}

function login() {
  const normalizedEmail = normalizeBanEmail(emailInput.value);
  const key = getBanStorageKey(normalizedEmail);
  if (key && localStorage.getItem(key) === "1") {
    alert("This device has a local ban flag for this account. Login will be rechecked against ban status.");
  }

  auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value)
    .catch(e => alert(e.message));
}

function logout() { auth.signOut(); }

auth.onAuthStateChanged(user => {
  if (!user) {
    stopXpLoop();
    loginArea.style.display = "block";
    userArea.style.display = "none";
    currentUserData = null;
    showResults(searchInput.value.toLowerCase());
    return;
  }

  startXpLoop();

  loginArea.style.display = "none";
  userArea.style.display = "block";

  db.collection("users").doc(user.uid).onSnapshot(doc => {
    currentUserData = doc.data() || {};
    const accountEmail = currentUserData.email || user.email || "";

    if (currentUserData.banned) {
      setDeviceBan(accountEmail, true);
      alert("Your account is banned.");
      auth.signOut();
      return;
    }

    setDeviceBan(accountEmail, false);

    keyCount.textContent = currentUserData.keys || 0;
    xpCount.textContent = currentUserData.xp || 0;

    const required = getXpRequiredForNextKey(currentUserData.keys || 0);
    const progress = Math.min(100, ((currentUserData.xp || 0) / required) * 100);
    xpBar.style.width = progress + "%";

    updateClaimButton();
    showUnlockedFeatures();
    lockFeatures();
    showResults(searchInput.value.toLowerCase());

    if (!currentUserData?.finalPopupSeen) {
      document.getElementById("finalPopup").style.display = "flex";
    }
  });
});

const featureCosts = {
  "Soundboard": 1,
  "Gauth": 2,
  "AI": 2,
  "Homework Forum": 3
};
const KEY_XP_STEPS = [100, 300, 600, 1200, 1800, 3000, 3000, 3000];

function lockFeatures(forceLock = false) {
  if (!auth.currentUser && !forceLock) return;
  document.querySelectorAll(".sidebar button").forEach(btn => {
    const name = btn.textContent.trim().replace(/^üõí\s|^üéÆ\s/, "");
    if (name === "Games" || name === "Shop") return;

    const url = btn.dataset.url;
    if (!url) return;

    const featureId = featureIdFromName(name);

    btn.onclick = () => {
      if (!auth.currentUser) {
        alert("Login to unlock features!");
        return;
      }

      const unlocked = currentUserData.unlocked?.[featureId];

      if (unlocked) {
        loadDirect(url);
        return;
      }

      const cost = featureCosts[name] || 0;

      if (currentUserData.keys < cost) {
        alert(`You need ${cost} keys to unlock this`);
        return;
      }

      db.collection("users").doc(auth.currentUser.uid).update({
        keys: firebase.firestore.FieldValue.increment(-cost),
        [`unlocked.${featureId}`]: true
      });

      loadDirect(url);
    };

    if (!currentUserData?.unlocked?.[featureId]) btn.style.opacity = "0.85";
    else btn.style.opacity = "1";

    if (forceLock) btn.style.opacity = "0.85";
  });
}
</script>

<script>
let lastActivity = Date.now();
["mousemove","keydown","click","scroll","touchstart"].forEach(evt =>
  document.addEventListener(evt, () => lastActivity = Date.now(), { passive:true })
);

let xpInterval = null;

function startXpLoop() {
  if (xpInterval) return;
  xpInterval = setInterval(() => {
    if (!auth.currentUser) return;

    const now = Date.now();
    const active = (now - lastActivity) < 60000;
    if (!active || document.hidden) return;

    db.collection("users").doc(auth.currentUser.uid).update({
      xp: firebase.firestore.FieldValue.increment(100)
    });
  }, 10000);
}

function stopXpLoop() {
  clearInterval(xpInterval);
  xpInterval = null;
}

function getXpRequiredForNextKey(keysOwned) {
  if (keysOwned < KEY_XP_STEPS.length) return KEY_XP_STEPS[keysOwned];
  return KEY_XP_STEPS[KEY_XP_STEPS.length - 1];
}

/* Features list (kept to non-bypass destinations) */
const FEATURES = [
  { name: "Soundboard", cost: 1, url: "/soundboard.html" },
  { name: "Gauth", cost: 2, url: "https://gauthmath.com" },
  { name: "AI", cost: 2, url: "https://heck.ai" },
  { name: "Casino", cost: 3, url: "/casino.html" },
  { name: "Homework Forum", cost: 3, url: "/homeworkforum.html" },
];

shopBtn.onclick = () => {
  document.querySelectorAll(".sidebar > button").forEach(b => b.style.display = "none");
  shopPanel.style.display = "flex";
  renderShop();
};

function closeShop() {
  shopPanel.style.display = "none";
  document.querySelectorAll(".sidebar > button").forEach(b => b.style.display = "flex");
}

function renderShop() {
  shopItems.innerHTML = "";

  FEATURES.forEach(f => {
    const id = featureIdFromName(f.name);
    const unlocked = currentUserData?.unlocked?.[id];

    const card = document.createElement("div");
    card.className = "shop-card";

    const title = document.createElement("h3");
    title.textContent = f.name;

    const desc = document.createElement("p");
    desc.textContent = unlocked
      ? "Unlocked permanently"
      : `Unlock this feature for ${f.cost} Keys`;

    const btn = document.createElement("button");

    if (unlocked) {
      btn.textContent = "OPEN";
      btn.className = "open-btn";
      btn.onclick = () => loadDirect(f.url);
    } else {
      btn.textContent = `UNLOCK ‚Ä¢ ${f.cost} üîë`;
      btn.className = "unlock-btn";
      btn.onclick = () => unlockFeature(f);
    }

    card.appendChild(title);
    card.appendChild(desc);
    card.appendChild(btn);
    shopItems.appendChild(card);
  });
}

function unlockFeature(feature) {
  const id = featureIdFromName(feature.name);

  if (currentUserData.keys < feature.cost) {
    alert("Not enough keys!");
    return;
  }

  db.collection("users").doc(auth.currentUser.uid).update({
    keys: firebase.firestore.FieldValue.increment(-feature.cost),
    [`unlocked.${id}`]: true
  });
}

function showUnlockedFeatures() {
  document.querySelectorAll(".feature-btn").forEach(b => b.remove());

  FEATURES.forEach(f => {
    const id = featureIdFromName(f.name);
    if (!currentUserData?.unlocked?.[id]) return;

    const btn = document.createElement("button");
    btn.textContent = `‚ú® ${f.name}`;
    btn.classList.add("btn", "feature-btn");
    btn.onclick = () => loadDirect(f.url);

    document.querySelector(".sidebar").insertBefore(btn, shopBtn.nextSibling);
  });
}

function updateClaimButton() {
  if (!currentUserData) return;

  const required = getXpRequiredForNextKey(currentUserData.keys);
  claimKeyBtn.style.display = currentUserData.xp >= required ? "flex" : "none";
}

claimKeyBtn.onclick = () => {
  const required = getXpRequiredForNextKey(currentUserData.keys);
  db.collection("users").doc(auth.currentUser.uid).update({
    xp: firebase.firestore.FieldValue.increment(-required),
    keys: firebase.firestore.FieldValue.increment(1)
  });
  alert("You earned a Vault Key!");
};

function closeFinalPopup() {
  document.getElementById("finalPopup").style.display = "none";
  if (auth.currentUser) {
    db.collection("users").doc(auth.currentUser.uid).update({ finalPopupSeen: true });
  }
}

  document.addEventListener("DOMContentLoaded", () => {
    if (!window.__ADMIN_MODE__) return;

    const sidebar = document.querySelector(".sidebar");
    const shopBtn = document.getElementById("shopBtn");
    if (!sidebar || !shopBtn) return;

    const adminBtn = document.createElement("button");
    adminBtn.className = "btn primary";   // uses your vault styling
    adminBtn.textContent = "üõ† Admin Panel";

    adminBtn.onclick = () => {
      // change this path to wherever your admin html lives
      loadDirect("/admin.html");
    };

    sidebar.insertBefore(adminBtn, shopBtn.nextSibling);
  });
</script>

<div id="finalPopup" style="display:none;">
  <div id="finalPopupBox">
    <h2>The Vault</h2>
    <p>Quick update about the future of this site:</p>
    <p>
      I built The Vault to provide a gaming website and make money off of it. I learned the hard way that isn't as easy as it seems.
      I will finish what I started with the new XP + Key system to try to make some money.
    </p>
    <p>
      I won‚Äôt be adding new stuff after this. The site will stay online,
      and you can keep using everything that‚Äôs here, but updates have officially wrapped up.
      I will be removing ads in the next week or so as well.
    </p>
    <p>Maybe I'll change my mind someday, but for now, thanks for everything.</p>
    <button onclick="closeFinalPopup()">Close</button>
  </div>
</div>


  
</body>
</html>
